{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar models_1 = require(\"../../models\");\n\nvar parser_configuration_1 = require(\"../parser-configuration\");\n\nvar BrowserRichTextParser =\n/** @class */\nfunction () {\n  function BrowserRichTextParser() {}\n\n  BrowserRichTextParser.prototype.resolveRichTextElement = function (resolverContext, contentItemCodename, html, elementName, replacement, config) {\n    var doc = this.createWrapperElement(html); // get all linked items\n\n    var result = this.processRichTextElement(resolverContext, contentItemCodename, elementName, doc.children, replacement, config, {\n      links: [],\n      linkedItems: [],\n      images: []\n    });\n    return {\n      links: result.links,\n      linkedItems: result.linkedItems,\n      images: result.images,\n      resolvedHtml: doc.innerHTML\n    };\n  };\n\n  BrowserRichTextParser.prototype.createWrapperElement = function (html) {\n    var element = document.createElement(parser_configuration_1.parserConfiguration.linkedItemWrapperElem);\n    element.innerHTML = html;\n    return element;\n  };\n\n  BrowserRichTextParser.prototype.processRichTextElement = function (resolverContext, contentItemCodename, elementName, htmlCollection, replacement, config, result) {\n    if (!htmlCollection || htmlCollection.length === 0) {// there are no more nodes\n    } else {\n      // extract objects\n      for (var i = 0; i < htmlCollection.length; i++) {\n        var element = htmlCollection[i];\n        var typeAttribute = element.attributes ? element.attributes.getNamedItem('type') : undefined; // process linked items (modular items)\n\n        if (element.attributes && typeAttribute && typeAttribute.value && typeAttribute.value.toLowerCase() === parser_configuration_1.parserConfiguration.modularContentElementData.type.toLowerCase()) {\n          var dataCodenameAttribute = element.attributes.getNamedItem(parser_configuration_1.parserConfiguration.modularContentElementData.dataCodename);\n          var dataTypeAttribute = element.attributes.getNamedItem(parser_configuration_1.parserConfiguration.modularContentElementData.dataType);\n\n          if (!dataTypeAttribute) {\n            throw Error('Missing data type attribute. This is likely an error caused by invalid response.');\n          }\n\n          var relAttribute = element.attributes.getNamedItem(parser_configuration_1.parserConfiguration.modularContentElementData.relAttribute);\n          var itemType = 'linkedItem';\n\n          if (relAttribute && relAttribute.value === parser_configuration_1.parserConfiguration.modularContentElementData.componentRel) {\n            itemType = 'component';\n          } // prepare link item object\n\n\n          var linkItemContentObject = {\n            dataCodename: dataCodenameAttribute ? dataCodenameAttribute.value : '',\n            dataType: dataTypeAttribute ? dataTypeAttribute.value : '',\n            itemType: itemType\n          }; // replace html\n\n          var parentElement = element.parentElement;\n\n          if (!parentElement) {\n            console.warn(\"Could not replace linked item '\" + linkItemContentObject.dataCodename + \"' of '\" + linkItemContentObject.dataType + \"' because parent node is undefined. Please report this error if you are seeing this.\");\n          } else {\n            if (dataTypeAttribute.value === 'item') {\n              // add to result\n              result.linkedItems.push(linkItemContentObject); // create new element\n\n              var newElem = document.createElement(config.linkedItemWrapperTag); // get type of resolving item\n\n              var type = void 0;\n              type = models_1.RichTextItemDataType.Item;\n              var linkedItemHtml = replacement.getLinkedItemHtml(linkItemContentObject.dataCodename, type); // recursively run resolver on the HTML obtained by resolver\n\n              newElem.innerHTML = this.resolveRichTextElement('nested', linkItemContentObject.dataCodename, linkedItemHtml, elementName, replacement, config).resolvedHtml; // add classes\n\n              newElem.className = config.linkedItemWrapperClasses.map(function (m) {\n                return m;\n              }).join(' '); // replace original node with new one\n\n              parentElement.replaceChild(newElem, element);\n            } else {\n              if (config.enableAdvancedLogging) {\n                console.warn(\"Rich text element contains object with unsupported data type '\" + dataTypeAttribute.value + \"'\");\n              }\n            }\n          }\n        } // process links\n\n\n        if (element.nodeName.toLowerCase() === parser_configuration_1.parserConfiguration.linkElementData.nodeName.toLowerCase()) {\n          var dataItemIdAttribute = element.attributes.getNamedItem(parser_configuration_1.parserConfiguration.linkElementData.dataItemId);\n\n          if (dataItemIdAttribute) {\n            var link = {\n              dataItemId: dataItemIdAttribute ? dataItemIdAttribute.value : ''\n            }; // add to result\n\n            result.links.push(link); // get original link text (the one inside <a> tag)\n\n            var linkText = element.innerHTML;\n            var urlSlugResult = replacement.getUrlSlugResult(link.dataItemId, linkText); // html has priority over url resolver\n\n            if (urlSlugResult.html) {\n              // replace link html\n              var linkHtml = urlSlugResult.html;\n              element.outerHTML = linkHtml ? linkHtml : '';\n              var parent_1 = element.parentNode;\n\n              if (parent_1) {\n                parent_1.replaceChild(element, element);\n              }\n            } else if (urlSlugResult.url) {\n              // set link url only\n              var hrefAttribute = element.attributes.getNamedItem('href');\n\n              if (!hrefAttribute) {\n                // href attribute is missing\n                if (config.enableAdvancedLogging) {\n                  console.warn(\"Cannot set url '\" + urlSlugResult + \"' because 'href' attribute is not present in the <a> tag.\\n                                        Please report this issue if you are seeing this.\\n                                        This warning can be turned off by disabling 'enableAdvancedLogging' option.\");\n                }\n              } else {\n                // get link url\n                var linkUrlResult = typeof urlSlugResult === 'string' ? urlSlugResult : urlSlugResult.url;\n                hrefAttribute.value = linkUrlResult ? linkUrlResult : '';\n              }\n            }\n          }\n        } // process images\n\n\n        if (element.nodeName.toLowerCase() === parser_configuration_1.parserConfiguration.imageElementData.nodeName.toLowerCase()) {\n          var dataImageIdAttribute = element.attributes.getNamedItem(parser_configuration_1.parserConfiguration.imageElementData.dataImageId); // continue only if data image id is present. There could be regular img tags included\n\n          if (dataImageIdAttribute) {\n            var imageObj = {\n              imageId: dataImageIdAttribute.value\n            };\n            result.images.push(imageObj); // get image result\n\n            var imageResult = replacement.getImageResult(resolverContext, contentItemCodename, imageObj.imageId, elementName); // get src attribute of img tag\n\n            var srcAttribute = element.attributes.getNamedItem(parser_configuration_1.parserConfiguration.imageElementData.srcAttribute);\n\n            if (!srcAttribute) {\n              throw Error(\"Attribute '\" + parser_configuration_1.parserConfiguration.imageElementData.srcAttribute + \"' is missing. Source element: \" + elementName);\n            } // set new image url\n\n\n            srcAttribute.value = imageResult.url;\n          }\n        } // recursively process child nodes\n\n\n        if (element.children && element.children.length > 0) {\n          this.processRichTextElement(resolverContext, contentItemCodename, elementName, element.children, replacement, config, result);\n        }\n      }\n    }\n\n    return result;\n  };\n\n  return BrowserRichTextParser;\n}();\n\nexports.BrowserRichTextParser = BrowserRichTextParser;","map":null,"metadata":{},"sourceType":"script"}