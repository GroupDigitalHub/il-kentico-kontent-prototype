{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar elements_1 = require(\"../elements\");\n\nvar RichTextResolver =\n/** @class */\nfunction () {\n  function RichTextResolver() {}\n  /**\r\n   * Resolves linked items inside the Rich text element.\r\n   * Rich text resolved needs to be configured either on the model or query level\r\n   */\n\n\n  RichTextResolver.prototype.resolveData = function (contentItemCodename, html, elementName, data) {\n    var _this = this; // prepare config\n\n\n    var config = {\n      enableAdvancedLogging: data.enableAdvancedLogging,\n      queryConfig: data.queryConfig,\n      linkedItemWrapperTag: data.linkedItemWrapperTag,\n      linkedItemWrapperClasses: data.linkedItemWrapperClasses\n    };\n    var result = data.richTextHtmlParser.resolveRichTextElement('root', contentItemCodename, html, elementName, {\n      getUrlSlugResult: function getUrlSlugResult(itemId, linkText) {\n        return _this.getUrlSlugResult({\n          config: config,\n          links: data.links,\n          itemId: itemId,\n          getLinkedItem: data.getLinkedItem,\n          linkText: linkText\n        });\n      },\n      getLinkedItemHtml: function getLinkedItemHtml(itemCodename, itemType) {\n        return _this.getLinkedItemHtml({\n          itemCodename: itemCodename,\n          config: config,\n          getLinkedItem: data.getLinkedItem,\n          itemType: itemType\n        });\n      },\n      getImageResult: function getImageResult(resolverContext, itemCodename, imageId, xElementName) {\n        return _this.getImageResult({\n          resolverContext: resolverContext,\n          getLinkedItem: data.getLinkedItem,\n          itemCodename: itemCodename,\n          config: config,\n          imageId: imageId,\n          images: data.images,\n          html: html,\n          elementName: xElementName\n        });\n      }\n    }, {\n      enableAdvancedLogging: data.enableAdvancedLogging,\n      queryConfig: data.queryConfig,\n      linkedItemWrapperTag: data.linkedItemWrapperTag,\n      linkedItemWrapperClasses: data.linkedItemWrapperClasses\n    });\n    return {\n      html: result.resolvedHtml,\n      componentCodenames: result.linkedItems.filter(function (m) {\n        return m.itemType === 'component';\n      }).map(function (m) {\n        return m.dataCodename;\n      }),\n      linkedItemCodenames: result.linkedItems.filter(function (m) {\n        return m.itemType === 'linkedItem';\n      }).map(function (m) {\n        return m.dataCodename;\n      })\n    };\n  };\n\n  RichTextResolver.prototype.getImageResult = function (data) {\n    // get linked item\n    var linkedItem = data.getLinkedItem(data.itemCodename);\n\n    if (!linkedItem) {\n      if (data.config.queryConfig.throwErrorForMissingLinkedItems) {\n        throw Error(\"Linked item with codename '\" + data.itemCodename + \"' was not found when resolving image with id '\" + data.imageId + \"'\");\n      }\n\n      if (data.config.enableAdvancedLogging) {\n        console.warn(\"Cannot resolve image with id '\" + data.imageId + \"' because linked item with codename '\" + data.itemCodename + \"' is not available. Empty image URL is returned.\");\n      }\n\n      return {\n        url: ''\n      };\n    } // if image is resolved within nested linked item (e.g. rich text element resolves html of linked item which contains images)\n    // the element name is equal to the 'root' element on which the html is resolved. For this reason we have to go through all\n    // elements in linked item and find the image there.\n\n\n    var image;\n\n    if (data.resolverContext === 'nested') {\n      image = this.tryGetImageFromLinkedItem(data.imageId, linkedItem);\n    } else {\n      var richTextElement = linkedItem[data.elementName];\n\n      if (!(richTextElement instanceof elements_1.Elements.RichTextElement)) {\n        throw Error(\"Linked item with codename '\" + data.itemCodename + \"' has invalid element '\" + data.elementName + \"'. This element is required to be of RichText type.\");\n      }\n\n      image = richTextElement.images.find(function (m) {\n        return m.imageId === data.imageId;\n      });\n    }\n\n    if (!image) {\n      throw Error(\"Image with id '\" + data.imageId + \"' was not found in images data for linked item '\" + data.itemCodename + \"' and element '\" + data.elementName + \"'\");\n    } // use custom resolver if present\n\n\n    if (data.config.queryConfig.richTextImageResolver) {\n      return data.config.queryConfig.richTextImageResolver(image, data.elementName);\n    } // use default resolver\n\n\n    return {\n      url: image.url\n    };\n  };\n\n  RichTextResolver.prototype.tryGetImageFromLinkedItem = function (imageId, contentItem) {\n    for (var _i = 0, _a = Object.keys(contentItem); _i < _a.length; _i++) {\n      var propName = _a[_i];\n      var prop = contentItem[propName];\n\n      if (prop instanceof elements_1.Elements.RichTextElement) {\n        var image = prop.images.find(function (m) {\n          return m.imageId === imageId;\n        });\n\n        if (image) {\n          return image;\n        }\n      }\n    }\n\n    return undefined;\n  };\n\n  RichTextResolver.prototype.getLinkedItemHtml = function (data) {\n    // get linked item\n    var linkedItem = data.getLinkedItem(data.itemCodename); // resolving cannot be done if the item is not present in response\n\n    if (!linkedItem) {\n      if (data.config.queryConfig.throwErrorForMissingLinkedItems) {\n        throw Error(\"Linked item with codename '\" + data.itemCodename + \"' could not be found in response and therefore the HTML of rich text element could not be evaluated. Increasing 'depth' parameter of your query may solve this issue.\");\n      }\n\n      if (data.config.enableAdvancedLogging) {\n        console.warn(\"Cannot resolve linked item '\" + data.itemCodename + \"' because it is not available in response. Increasing 'depth' parameter of query may help. Item is resolved to empty string.\");\n      }\n\n      return '';\n    } // get html to replace object using Rich text resolver function\n\n\n    var resolver = undefined;\n\n    if (data.config.queryConfig.richTextResolver) {\n      // use resolved defined by query if available\n      resolver = data.config.queryConfig.richTextResolver;\n    } else {\n      // use default resolver defined in models\n      if (linkedItem._config && linkedItem._config.richTextResolver) {\n        resolver = linkedItem._config.richTextResolver;\n      }\n    } // check resolver\n\n\n    if (!resolver) {\n      if (data.config.enableAdvancedLogging) {\n        console.warn(\"Cannot resolve html of '\" + linkedItem.system.type + \"' used by item '\" + data.itemCodename + \"' type in 'RichTextElement' because no rich text resolver was configured. Item is resolved to empty string.\");\n        return '';\n      }\n\n      return '';\n    }\n\n    return resolver(linkedItem, {\n      contentType: data.itemType\n    });\n  };\n\n  RichTextResolver.prototype.getUrlSlugResult = function (data) {\n    // find link with the id of content item\n    var existingLink = data.links.find(function (m) {\n      return m.linkId === data.itemId;\n    });\n\n    if (!existingLink) {\n      if (data.config.enableAdvancedLogging) {\n        console.warn(\"Cannot resolve URL for item '\" + data.itemId + \"' because no link with this id was found.\");\n      }\n\n      return {\n        html: '',\n        url: ''\n      };\n    }\n\n    var linkedItem = data.getLinkedItem(existingLink.codename); // prepare link context\n\n    var linkContext = {\n      linkText: data.linkText,\n      item: linkedItem,\n      linkId: data.itemId\n    }; // try to resolve link using the resolver passed through the query config\n\n    var queryUrlSlugResolver = data.config.queryConfig.urlSlugResolver;\n\n    if (queryUrlSlugResolver) {\n      // resolve url using query config\n      var queryUrlSlugResult = queryUrlSlugResolver(existingLink, linkContext);\n\n      if (queryUrlSlugResult) {\n        return queryUrlSlugResult;\n      }\n    } // url was not resolved, try using global link resolver for item\n\n\n    if (linkedItem && linkedItem._config && linkedItem._config.urlSlugResolver) {\n      var globalUrlSlugResult = linkedItem._config.urlSlugResolver(existingLink, linkContext);\n\n      if (globalUrlSlugResult) {\n        return globalUrlSlugResult;\n      }\n    } // url wasn't resolved\n\n\n    if (data.config.enableAdvancedLogging) {\n      console.warn(\"Url for item of '\" + existingLink.type + \"' type with id '\" + existingLink.linkId + \"' wasn't resolved. This might be caused by missing 'urlSlugResolver' for given type.\");\n    }\n\n    return {\n      html: '',\n      url: ''\n    };\n  };\n\n  return RichTextResolver;\n}();\n\nexports.RichTextResolver = RichTextResolver;\nexports.richTextResolver = new RichTextResolver();","map":null,"metadata":{},"sourceType":"script"}