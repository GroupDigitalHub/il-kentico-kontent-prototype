{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar parse5_1 = require(\"parse5\");\n\nvar models_1 = require(\"../../models\");\n\nvar parser_configuration_1 = require(\"../parser-configuration\");\n\nvar parse5utils_1 = require(\"./parse5utils\");\n\nvar Parse5RichTextParser =\n/** @class */\nfunction () {\n  function Parse5RichTextParser() {\n    this.resolvedLinkedItemAttribute = 'data-sdk-resolved';\n  }\n\n  Parse5RichTextParser.prototype.resolveRichTextElement = function (resolverContext, contentItemCodename, html, elementName, replacement, config) {\n    // create document\n    var documentFragment = parse5_1.parseFragment(html); // get all linked items\n\n    var result = this.processRichTextElement(resolverContext, contentItemCodename, elementName, this.getChildNodes(documentFragment), replacement, config, {\n      links: [],\n      linkedItems: [],\n      images: []\n    });\n    var resolvedHtml = parse5_1.serialize(documentFragment);\n    return {\n      links: result.links,\n      linkedItems: result.linkedItems,\n      images: result.images,\n      resolvedHtml: resolvedHtml\n    };\n  };\n\n  Parse5RichTextParser.prototype.processRichTextElement = function (resolverContext, contentItemCodename, elementName, elements, replacement, config, result) {\n    var _this = this;\n\n    if (!elements || elements.length === 0) {// there are no more elements\n    } else {\n      elements.forEach(function (element) {\n        if (element.attrs) {\n          _this.processModularContentItem(resolverContext, elementName, element, replacement, config, result);\n\n          _this.processImage(resolverContext, contentItemCodename, elementName, element, replacement, config, result);\n\n          _this.processLink(element, replacement, config, result);\n        }\n\n        if (element.childNodes) {\n          // recursively process all childs\n          _this.processRichTextElement(resolverContext, contentItemCodename, elementName, _this.getChildNodes(element), replacement, config, result);\n        }\n      });\n    }\n\n    return result;\n  };\n\n  Parse5RichTextParser.prototype.processImage = function (resolverContext, contentItemCodename, elementName, element, replacement, config, result) {\n    var attributes = element.attrs;\n\n    if (element.nodeName !== parser_configuration_1.parserConfiguration.imageElementData.nodeName) {\n      // node is not an image\n      return;\n    } // get image id attribute\n\n\n    var dataImageIdAttribute = attributes.find(function (m) {\n      return m.name === parser_configuration_1.parserConfiguration.imageElementData.dataImageId;\n    });\n\n    if (!dataImageIdAttribute) {\n      // image tag does not have image id attribute\n      return;\n    } // prepare link object\n\n\n    var image = {\n      imageId: dataImageIdAttribute.value\n    }; // add link to result\n\n    result.images.push(image);\n    var linkResult = replacement.getImageResult(resolverContext, contentItemCodename, image.imageId, elementName); // set url of image\n\n    var srcAttribute = attributes.find(function (m) {\n      return m.name === parser_configuration_1.parserConfiguration.imageElementData.srcAttribute;\n    });\n\n    if (srcAttribute) {\n      srcAttribute.value = linkResult.url;\n    }\n  };\n\n  Parse5RichTextParser.prototype.processLink = function (element, replacement, config, result) {\n    var attributes = element.attrs;\n\n    if (element.nodeName !== parser_configuration_1.parserConfiguration.linkElementData.nodeName) {\n      // node is not a link\n      return;\n    } // get all links which have item it attribute, ignore all other links (they can be regular links in rich text)\n\n\n    var dataItemIdAttribute = attributes.find(function (m) {\n      return m.name === parser_configuration_1.parserConfiguration.linkElementData.dataItemId;\n    });\n\n    if (!dataItemIdAttribute) {\n      // its either a regular link or the attribute is not defined\n      return;\n    } // prepare link object\n\n\n    var link = {\n      dataItemId: dataItemIdAttribute ? dataItemIdAttribute.value : ''\n    }; // add link to result\n\n    result.links.push(link); // get original link text (the one inside <a> tag from response)\n\n    var originalLinkText = undefined;\n    var linkTextNode = element.childNodes[0];\n\n    if (linkTextNode) {\n      originalLinkText = linkTextNode.value;\n    }\n\n    var urlSlugResult = replacement.getUrlSlugResult(link.dataItemId, originalLinkText || ''); // html has priority over url\n\n    if (urlSlugResult.html) {\n      // replace entire link html\n      var linkHtml = urlSlugResult.html ? urlSlugResult.html : '';\n\n      if (linkHtml) {\n        var newNode = parse5_1.parseFragment(parse5utils_1.parse5Utils.createTextNode(''), linkHtml);\n        parse5utils_1.parse5Utils.replaceNode(element, newNode.childNodes[0]);\n      }\n    } else if (urlSlugResult.url) {\n      // replace just link href\n      var hrefAttribute = attributes.find(function (m) {\n        return m.name === 'href';\n      });\n\n      if (!hrefAttribute) {\n        // href attribute is missing\n        if (config.enableAdvancedLogging) {\n          console.warn(\"Cannot set url '\" + urlSlugResult + \"' because 'href' attribute is not present in the <a> tag. Please report this issue if you are seeing this. This warning can be turned off by disabling 'enableAdvancedLogging' option.\");\n        }\n      } else {\n        // get link url\n        var linkUrlResult = typeof urlSlugResult === 'string' ? urlSlugResult : urlSlugResult.url;\n        hrefAttribute.value = linkUrlResult ? linkUrlResult : '';\n      }\n    }\n  };\n\n  Parse5RichTextParser.prototype.processModularContentItem = function (resolverContext, elementName, element, replacement, config, result) {\n    var _this = this;\n\n    var attributes = element.attrs;\n    var dataTypeAttribute = attributes.find(function (m) {\n      return m.name === parser_configuration_1.parserConfiguration.modularContentElementData.dataType;\n    });\n    var resolvedDataAttribute = attributes.find(function (m) {\n      return m.name === _this.resolvedLinkedItemAttribute;\n    }); // process linked itmes\n\n    if (dataTypeAttribute && !resolvedDataAttribute) {\n      // get type of resolving item\n      var type = void 0;\n\n      if (dataTypeAttribute.value === 'item') {\n        type = models_1.RichTextItemDataType.Item; // get codename of the modular content\n\n        var dataCodenameAttribute = attributes.find(function (m) {\n          return m.name === parser_configuration_1.parserConfiguration.modularContentElementData.dataCodename;\n        });\n\n        if (dataCodenameAttribute == null) {\n          throw Error(\"The '\" + parser_configuration_1.parserConfiguration.modularContentElementData.dataCodename + \"' attribute is missing and therefore linked item cannot be retrieved\");\n        }\n\n        var itemCodename = dataCodenameAttribute.value;\n        var itemType = 'linkedItem'; // get rel attribute for components\n\n        var relAttribute = attributes.find(function (m) {\n          return m.name === parser_configuration_1.parserConfiguration.modularContentElementData.relAttribute;\n        });\n\n        if (relAttribute && relAttribute.value === parser_configuration_1.parserConfiguration.modularContentElementData.componentRel) {\n          itemType = 'component';\n        }\n\n        var linkedItem = {\n          dataCodename: dataCodenameAttribute ? dataCodenameAttribute.value : '',\n          dataType: dataTypeAttribute ? dataTypeAttribute.value : '',\n          itemType: itemType\n        }; // add to result\n\n        result.linkedItems.push(linkedItem);\n        var linkedItemHtml = replacement.getLinkedItemHtml(itemCodename, type); // flag element as resolved to avoid duplicate resolving\n\n        element.attrs.push({\n          name: this.resolvedLinkedItemAttribute,\n          value: '1'\n        }); // get html\n\n        var resultHtml = this.resolveRichTextElement('nested', itemCodename, linkedItemHtml, elementName, replacement, config).resolvedHtml; // replace 'object' tag name\n\n        element.tagName = config.linkedItemWrapperTag; // add classes\n\n        element.attrs.push({\n          name: 'class',\n          value: config.linkedItemWrapperClasses.map(function (m) {\n            return m;\n          }).join(' ')\n        }); // get serialized set of nodes from HTML\n\n        var serializedChildNodes = parse5_1.parseFragment(resultHtml); // add child nodes\n\n        element.childNodes = serializedChildNodes.childNodes;\n      } else {\n        if (config.enableAdvancedLogging) {\n          console.warn(\"Rich text element contains object with unsupported data type '\" + dataTypeAttribute.value + \"'\");\n        }\n      }\n    }\n  };\n\n  Parse5RichTextParser.prototype.getChildNodes = function (documentFragment) {\n    return documentFragment.childNodes;\n  };\n\n  return Parse5RichTextParser;\n}();\n\nexports.Parse5RichTextParser = Parse5RichTextParser;","map":null,"metadata":{},"sourceType":"script"}