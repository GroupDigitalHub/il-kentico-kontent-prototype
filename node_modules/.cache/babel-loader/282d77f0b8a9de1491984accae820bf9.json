{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar kontent_core_1 = require(\"@kentico/kontent-core\");\n\nvar rxjs_1 = require(\"rxjs\");\n\nvar operators_1 = require(\"rxjs/operators\");\n\nvar BaseDeliveryQueryService =\n/** @class */\nfunction () {\n  function BaseDeliveryQueryService(\n  /**\r\n   * Delivery client configuration\r\n   */\n  config,\n  /**\r\n   * Http service for fetching data\r\n   */\n  httpService,\n  /**\r\n   * Information about the SDK\r\n   */\n  sdkInfo,\n  /**\r\n   * Mapping service\r\n   */\n  mappingService) {\n    this.config = config;\n    this.httpService = httpService;\n    this.sdkInfo = sdkInfo;\n    this.mappingService = mappingService;\n    /**\r\n    * Default number of retry attempts when user did not set any\r\n    */\n\n    this.defaultRetryAttempts = 3;\n    /**\r\n     * List of response codes that can be retried\r\n     */\n\n    this.defaultRetryStatusCodes = [500];\n    /**\r\n     * Header name for SDK usage\r\n     */\n\n    this.sdkVersionHeader = 'X-KC-SDKID';\n    /**\r\n     * Default base Url to Kentico Delivery API\r\n     */\n\n    this.defaultBaseDeliveryApiUrl = 'https://deliver.kontent.ai';\n    /**\r\n     * Default preview url to Kentico Delivery API\r\n     */\n\n    this.defaultPreviewDeliveryApiUrl = 'https://preview-deliver.kontent.ai';\n    /**\r\n     * Name of the header used when 'wait for loading new content' feature is used\r\n     */\n\n    this.waitForLoadingNewContentHeader = 'X-KC-Wait-For-Loading-New-Content';\n  }\n\n  BaseDeliveryQueryService.prototype.retryPromise = function (promise) {\n    return this.httpService.retryPromise(promise, {\n      maxRetryAttempts: this.getRetryAttempts(),\n      useRetryForResponseCodes: this.getRetryStatusCodes()\n    }, 1);\n  };\n  /**\r\n  * Gets url based on the action, query configuration and options (parameters)\r\n  * @param action Action (= url part) that will be hit\r\n  * @param queryConfig Query configuration\r\n  * @param options Query options\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getUrl = function (action, queryConfig, options) {\n    if (!this.config.proxy || !this.config.proxy.advancedProxyUrlResolver) {\n      return kontent_core_1.urlHelper.addOptionsToUrl(this.getBaseUrl(queryConfig) + action, options);\n    }\n\n    return this.config.proxy.advancedProxyUrlResolver({\n      queryParameters: options ? options : [],\n      queryString: kontent_core_1.urlHelper.addOptionsToUrl('', options),\n      action: action,\n      domain: this.getDomain(queryConfig),\n      queryConfig: queryConfig,\n      projectId: this.config.projectId\n    });\n  };\n  /**\r\n  * Gets proper set of headers for given request.\r\n  * @param queryConfig Query configuration\r\n  * @param customHeaders Custom headers\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getHeaders = function (queryConfig) {\n    var headers = []; // add SDK Id header for monitoring SDK usage\n\n    headers.push(this.getSdkIdHeader()); // add headers from global config\n\n    if (this.config.globalHeaders) {\n      headers.push.apply(headers, this.config.globalHeaders(queryConfig));\n    } // add query / global headers from query config\n\n\n    headers.push.apply(headers, this.getQueryHeaders(queryConfig));\n\n    if (this.isPreviewModeEnabled(queryConfig) && this.isSecuredModeEnabled(queryConfig)) {\n      throw Error(\"Preview & secured modes cannot be used at the same time.\");\n    } // add preview header is required\n\n\n    if (this.isPreviewModeEnabled(queryConfig) && this.config.previewApiKey) {\n      headers.push(this.getAuthorizationHeader(this.config.previewApiKey));\n    } // add secured mode header is required\n\n\n    if (this.isSecuredModeEnabled(queryConfig) && this.config.secureApiKey) {\n      headers.push(this.getAuthorizationHeader(this.config.secureApiKey));\n    } // add 'X-KC-Wait-For-Loading-New-Content' header if required\n\n\n    if (this.shouldAddWaitForLoadingNewContentHeader(queryConfig)) {\n      headers.push({\n        header: this.waitForLoadingNewContentHeader,\n        value: 'true'\n      });\n    }\n\n    return headers;\n  };\n  /**\r\n   * Http GET response\r\n   * @param url Url of request\r\n   * @param queryConfig Query config configuration\r\n   */\n\n\n  BaseDeliveryQueryService.prototype.getResponse = function (url, queryConfig) {\n    if (!queryConfig) {\n      queryConfig = {};\n    }\n\n    return this.httpService.get({\n      url: url,\n      mapError: function mapError(error) {\n        return kontent_core_1.mapBaseKontentError(error);\n      }\n    }, {\n      headers: this.getHeaders(queryConfig),\n      maxRetryAttempts: this.getRetryAttempts(),\n      useRetryForResponseCodes: this.getRetryStatusCodes(),\n      logErrorToConsole: this.config.isDeveloperMode\n    }).pipe(operators_1.catchError(function (error) {\n      return rxjs_1.throwError(error.mappedError);\n    }));\n  };\n  /**\r\n  * Gets base URL of the request including the project Id\r\n  * @param queryConfig Query configuration\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getBaseUrl = function (queryConfig) {\n    return this.getDomain(queryConfig) + '/' + this.config.projectId;\n  };\n  /**\r\n  * Gets retry status code array\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getRetryStatusCodes = function () {\n    if (this.config.retryStatusCodes) {\n      return this.config.retryStatusCodes;\n    }\n\n    return this.defaultRetryStatusCodes;\n  };\n  /**\r\n  * Gets number of retry attempts used by queries\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getRetryAttempts = function () {\n    // get the attempts\n    var attempts;\n\n    if (this.config.retryAttempts || this.config.retryAttempts === 0) {\n      // use custom defined number of attempts\n      attempts = this.config.retryAttempts;\n    } else {\n      // use default attempts\n      attempts = this.defaultRetryAttempts;\n    }\n\n    return attempts;\n  };\n  /**\r\n  * Indicates if current query should use preview mode\r\n  * @param queryConfig Query configuration\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.isPreviewModeEnabled = function (queryConfig) {\n    if (queryConfig.usePreviewMode !== undefined) {\n      return queryConfig.usePreviewMode;\n    }\n\n    if (!this.config.globalQueryConfig) {\n      return false;\n    }\n\n    if (this.config.globalQueryConfig.usePreviewMode === true) {\n      return true;\n    }\n\n    return false;\n  };\n\n  BaseDeliveryQueryService.prototype.getQueryHeaders = function (queryConfig) {\n    if (queryConfig.customHeaders) {\n      return queryConfig.customHeaders;\n    }\n\n    if (!this.config.globalQueryConfig || !this.config.globalQueryConfig.customHeaders) {\n      return [];\n    }\n\n    return this.config.globalQueryConfig.customHeaders;\n  };\n\n  BaseDeliveryQueryService.prototype.shouldAddWaitForLoadingNewContentHeader = function (queryConfig) {\n    if (queryConfig.waitForLoadingNewContent !== undefined) {\n      return queryConfig.waitForLoadingNewContent;\n    }\n\n    if (!this.config.globalQueryConfig) {\n      return false;\n    }\n\n    if (this.config.globalQueryConfig.waitForLoadingNewContent === true) {\n      return true;\n    }\n\n    return false;\n  };\n  /**\r\n  * Indicates if current query should use secured mode\r\n  * @param queryConfig Query configuration\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.isSecuredModeEnabled = function (queryConfig) {\n    if (queryConfig.useSecuredMode !== undefined) {\n      return queryConfig.useSecuredMode;\n    }\n\n    if (!this.config.globalQueryConfig) {\n      return false;\n    }\n\n    if (this.config.globalQueryConfig.useSecuredMode === true) {\n      return true;\n    }\n\n    return false;\n  };\n  /**\r\n  * Gets preview or standard URL based on client and query configuration\r\n  * @param queryConfig Query configuration\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getDomain = function (queryConfig) {\n    if (this.isPreviewModeEnabled(queryConfig)) {\n      if (!this.config.previewApiKey) {\n        throw Error(\"Preview API key is not configured.\");\n      } // check custom preview url\n\n\n      if (this.config.proxy && this.config.proxy.basePreviewUrl) {\n        return this.config.proxy.basePreviewUrl;\n      } // use default preview url\n\n\n      return this.defaultPreviewDeliveryApiUrl;\n    } // check custom base url\n\n\n    if (this.config.proxy && this.config.proxy.baseUrl) {\n      return this.config.proxy.baseUrl;\n    }\n\n    return this.defaultBaseDeliveryApiUrl;\n  };\n  /**\r\n  * Gets authorization header. This is used for 'preview' functionality\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getAuthorizationHeader = function (key) {\n    if (!key) {\n      throw Error(\"Cannot get authorization header because key is invalid\");\n    } // authorization header required for preview mode\n\n\n    return {\n      header: 'authorization',\n      value: \"bearer \" + key\n    };\n  };\n  /**\r\n  * Header identifying SDK type & version for internal purposes of Kentico\r\n  */\n\n\n  BaseDeliveryQueryService.prototype.getSdkIdHeader = function () {\n    return {\n      header: this.sdkVersionHeader,\n      value: this.sdkInfo.host + \";\" + this.sdkInfo.name + \";\" + this.sdkInfo.version\n    };\n  };\n\n  return BaseDeliveryQueryService;\n}();\n\nexports.BaseDeliveryQueryService = BaseDeliveryQueryService;","map":null,"metadata":{},"sourceType":"script"}